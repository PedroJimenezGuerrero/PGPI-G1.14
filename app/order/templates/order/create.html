{% extends "shop/base/base.html" %}
{% load crispy_forms_tags %}
{% block title %}
Checkout
{% endblock %}
{% block content %}
<div class="container">
    <div class="order-info">
        <h1 class="text-center">Tu pedido</h1>
        <ul style="color:black">
            {% for item in cart %}
            <li>
                {{ item.quantity }}x {{ item.product.name }}
                <span>{{ item.total_price }} €</span>
            </li>
            {% endfor %}
            <li id="reembolso-item" style="display: none;">
                1x Coste de reserva
                <span>5.00 €</span>
            </li>
        </ul>
        <h4 style="color:black">Total: <span id="total-price">{{ cart.get_total_price|floatformat:2 }} €</span></h4>
    </div>
    <form action="." method="post" class="order-form">
        {{ form|crispy }}
        <div style="display:flex; justify-content: center;">
            <b style="color:red;">Recuerde que no se admiten devoluciones.</b>
        </div>
        <div id="paypal-button-container"></div>

    <!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AQIfEdMolIem43n_KJR61hhhY5vbHSOtRb-3BRGur8Xo4KBslWUXO962BPkEEVQ1MwhntudZpd9ytbje&currency=EUR"></script>

    <script>
       // const total_price = {{ price }}
       var total = '{{ cart.get_total_price }}'
       //console.log({{ cart.get_total_price }})
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            style: {
                layout: 'horizontal'
            },
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount:{
                            value: parseFloat(total).toFixed(2)
                           // value: '0.1'
                        }
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    // Capturar datos del formulario
                    var formData = new FormData(document.querySelector('.order-form'));
    
                    // Añadir información de la transacción de PayPal
                    formData.append('payer_name', details.payer.name.given_name + ' ' + details.payer.name.surname);
                    formData.append('payer_email', details.payer.email_address);
                    formData.append('status', details.status);
                    formData.append('total_price', total); // Asegurarte de que el total sea enviado
    
                    // Enviar los datos al servidor
                    fetch('/order/create/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) {
                        // Si la respuesta no es JSON, asumimos que es HTML (redirección)
                        if (response.headers.get('content-type').includes('text/html')) {
                            return response.text().then(function(html) {
                                // Crear un documento temporal y redirigir al usuario
                                document.open();
                                document.write(html);
                                document.close();
                            });
                        }
                    
                        // Caso JSON: procesar como siempre
                        return response.json();
                    })
                    .then(function(data) {
                        // Mostrar un mensaje de éxito o redirigir
                        console.log('Respuesta del servidor:', data);
                        //alert('¡Transacción completada! Número de orden: ' + data);
                        //window.location.href = '/created/'; // Redirigir a una página de confirmación
                    })
                    .catch(function(error) {
                        console.log(error)
                        alert('Hubo un problema al procesar la orden.');
                    });
                });
            }
            /*
            // Call your server to set up the transaction
            createOrder: function(data, actions) {
                return fetch('/order/create', {
                    method: 'post'
                }).then(function(res) {
                    return res.json();
                }).then(function(orderData) {
                    return orderData.id;
                });
            },

            // Call your server to finalize the transaction
            onApprove: function(data, actions) {
                return fetch('/demo/checkout/api/paypal/order/' + data.orderID + '/capture/', {
                    method: 'post'
                }).then(function(res) {
                    return res.json();
                }).then(function(orderData) {
                    // Three cases to handle:
                    //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                    //   (2) Other non-recoverable errors -> Show a failure message
                    //   (3) Successful transaction -> Show confirmation or thank you

                    // This example reads a v2/checkout/orders capture response, propagated from the server
                    // You could use a different API or structure for your 'orderData'
                    var errorDetail = Array.isArray(orderData.details) && orderData.details[0];

                    if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                        return actions.restart(); // Recoverable state, per:
                        // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
                    }

                    if (errorDetail) {
                        var msg = 'Sorry, your transaction could not be processed.';
                        if (errorDetail.description) msg += '\n\n' + errorDetail.description;
                        if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
                        return alert(msg); // Show a failure message (try to avoid alerts in production environments)
                    }

                    // Successful capture! For demo purposes:
                    console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                    var transaction = orderData.purchase_units[0].payments.captures[0];
                    alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');

                    // Replace the above to show a success message within this page, e.g.
                    // const element = document.getElementById('paypal-button-container');
                    // element.innerHTML = '';
                    // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                    // Or go to another URL:  actions.redirect('thank_you.html');
                    
                });
            }
                */
        }).render('#paypal-button-container');
    </script>
    {% csrf_token %}
        <p><input class="btn btn-primary btn-sm btn-block" style="background-color: #0088FF;" type="submit" value="Finalizar"></p>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentMethodField = document.querySelector('select[name="payment_method"]');
        const totalPriceElement = document.getElementById('total-price');
        const reembolsoItem = document.getElementById('reembolso-item');
        const baseTotalPrice = parseFloat({{ cart.get_total_price|floatformat:2 }});

        paymentMethodField.addEventListener('change', function() {
            let totalPrice = baseTotalPrice;
            if (paymentMethodField.value === 'contrareembolso') {
                totalPrice += 5;
                reembolsoItem.style.display = 'list-item';
            } else {
                reembolsoItem.style.display = 'none';
            }
            totalPriceElement.textContent = totalPrice.toFixed(2) + ' €';
        });
    });
</script>
{% endblock %}